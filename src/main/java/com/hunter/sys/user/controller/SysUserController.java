package com.hunter.sys.user.controller;import com.alibaba.fastjson.JSONObject;import com.github.pagehelper.PageHelper;import com.github.pagehelper.PageInfo;import com.google.common.base.Strings;import com.google.common.collect.Maps;import com.hunter.base.vo.RequestData;import com.hunter.base.vo.ResponseData;import com.hunter.common.constant.BaseConstant;import com.hunter.common.constant.SysConstant;import com.hunter.common.constant.UserTypeEnum;import com.hunter.common.util.EncryptUtil;import com.hunter.common.util.UserUtil;import com.hunter.sys.user.entity.SysUser;import com.hunter.sys.user.service.SysUserService;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Controller;import org.springframework.ui.ModelMap;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.RequestMethod;import org.springframework.web.bind.annotation.ResponseBody;import javax.servlet.http.HttpServletRequest;import java.util.Date;import java.util.Map;/** * @Author zhangcl * @Date 16/7/9  下午6:07 */@Controller@RequestMapping("/sys/user")public class SysUserController {    @Autowired    private SysUserService sysUserService;    /**     * 跳转到增加页面     *     * @param request     * @param modelMap     * @return     */    @RequestMapping(value = "/add", method = RequestMethod.GET)    public String add(HttpServletRequest request, ModelMap modelMap) {        String id = request.getParameter("id");        String operate = request.getParameter("operate");        SysUser user = new SysUser();        if (!Strings.isNullOrEmpty(id)) {            user = sysUserService.findUserById(Long.valueOf(id));        }        modelMap.put("user", user);        modelMap.put("operate", operate);        modelMap.put("userTypeEnum", new UserTypeEnum[]{UserTypeEnum.NORMAL, UserTypeEnum.VIP});        return "sys/user/addUser";    }    /**     * 保存用户     *     * @param request     * @param modelMap     * @return     */    @RequestMapping(value = "/save", method = RequestMethod.POST)    public String save(HttpServletRequest request, SysUser sysUser, ModelMap modelMap) {        String hasModifyPwd = request.getParameter("hasModifyPwd");        long id = sysUser.getId();//        SysUser user =(SysUser)request.getSession().getAttribute("user");        Date now = new Date();        sysUser.setModifyTime(now);        sysUser.setModifyName(UserUtil.getCurrentUserAccount());        //新增        if (id == 0) {            //管理员            sysUser.setUserType(BaseConstant.STR_1);            sysUser.setCreateTime(now);            sysUser.setCreateName(UserUtil.getCurrentUserAccount());            sysUser.setPassword(EncryptUtil.encodeByMD5(EncryptUtil.encodeByMD5(EncryptUtil.encodeByMD5(sysUser.getPassword()) + sysUser.getPhone())));            sysUserService.save(sysUser);        } else {            if (hasModifyPwd.equals(SysConstant.YES_SIMPLE)) {                sysUser.setPassword(EncryptUtil.encodeByMD5(EncryptUtil.encodeByMD5(EncryptUtil.encodeByMD5(sysUser.getPassword()) + sysUser.getPhone())));            }            sysUserService.updateByEntity(sysUser);        }        return "redirect:list.do";    }    /**     * ajax请求,现在只处理分页     *     * @param request     * @return     */    @RequestMapping(value = "/ajax/list", produces = "application/json;charset=UTF-8")    @ResponseBody    public String ajaxList(RequestData requestData, HttpServletRequest request) {        //分页        PageHelper.startPage(requestData.getPageNum(), requestData.getLength());        //查出数据        PageInfo pageInfo = new PageInfo(sysUserService.findListByMap(requestData.getData()));        ResponseData responseData = new ResponseData(pageInfo);        //返回json        String json = responseData.getResultJson(requestData);        return json;    }    /**     * 用户列表     *     * @param request     * @param modelMap     * @return     */    @RequestMapping(value = "/list")    public String list(HttpServletRequest request, ModelMap modelMap) {        modelMap.put("name", request.getParameter("name"));        modelMap.put("userType", request.getParameter("userType"));        modelMap.put("phone", request.getParameter("phone"));        modelMap.put("userTypeEnum", UserTypeEnum.values());        return "sys/user/listUser";    }    /**     * 删除用户     *     * @param request     * @param modelMap     * @return     */    @RequestMapping(value = "/delete", method = RequestMethod.GET)    public String delete(HttpServletRequest request, ModelMap modelMap) {        String id = request.getParameter("id");        if (!Strings.isNullOrEmpty(id)) {            SysUser user = sysUserService.findUserById(Long.valueOf(id));            if (null != user) {                user.setHasDel(BaseConstant.INT_1);                user.setModifyName(UserUtil.getCurrentUserAccount());                user.setModifyTime(new Date());                sysUserService.updateByEntity(user);            }        }        return "redirect:list.do";    }    /**     * ajax请求,现在只处理分页     *     * @param request     * @return     */    @RequestMapping(value = "/ajax/validate/phone", produces = "application/json;charset=UTF-8")    @ResponseBody    public String validatePhone(HttpServletRequest request) {        String phone = request.getParameter("phone");        long id = request.getParameter("id") == null ? 0 : Long.valueOf(request.getParameter("id"));        Map map = Maps.newHashMapWithExpectedSize(1);        SysUser user = sysUserService.findOneByTypeAndPhone(String.valueOf(UserTypeEnum.ADMIN.getCode()), phone);        boolean valid = false;        //根据手机号没有查到其他人时,验证通过        if (user == null || user.getId() == id) {            valid = true;        }        map.put("valid", valid);        return JSONObject.toJSONString(map);    }}